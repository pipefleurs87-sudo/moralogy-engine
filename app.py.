import streamlit as st

# Cargar provider y keys desde secrets
try:
    api_provider = st.secrets["API_PROVIDER"]
    if api_provider == "grok":
        from openai import OpenAI
        api_key = st.secrets["GROK_API_KEY"]
        model_name = st.secrets["GROK_MODEL"]
        client = OpenAI(api_key=api_key, base_url="https://api.x.ai/v1")
    elif api_provider == "gemini":
import google.generativeai as genai
        api_key = st.secrets["GOOGLE_API_KEY"]
        model_name = st.secrets["GEMINI_MODEL"]
        genai.configure(api_key=api_key)
        client = genai.GenerativeModel(model_name)
    else:
        raise ValueError("API_PROVIDER debe ser 'grok' o 'gemini'")
except KeyError as e:
    st.error(f"Falta configuración en Secrets: {e}. Añade API_PROVIDER y las keys correspondientes.")
    st.stop()

# Diccionario de dilemas canónicos
canonical_dilemmas = {
    "The Trolley Problem": "A runaway trolley is headed towards five people. You can pull a lever to divert it to kill one person instead. Should you?",
    # Añade más si quieres
}

# Interfaz sidebar
st.sidebar.header("Configuration")
enable_safelock = st.sidebar.checkbox("Enable Divine Safelock", value=False)
selected_dilemma = st.sidebar.selectbox("Canonical Dilemmas", options=["Load example"] + list(canonical_dilemmas.keys()), index=0)

# Cargar dilema seleccionado
if selected_dilemma != "Load example":
    dilemma_text = canonical_dilemmas[selected_dilemma]
else:
    dilemma_text = ""

# Text area principal
dilemma = st.text_area("Describe the moral dilemma:", value=dilemma_text, height=100)

# Función de análisis (adaptada para ambos providers)
def analyze_moral_dilemma(dilemma_text, enable_safelock):
    system_prompt = """
Eres un motor de análisis moral extremadamente profundo, lógico y sin censuras.
Analiza el dilema desde múltiples perspectivas éticas: utilitarismo, deontología, ética de la virtud, contractualismo, egoísmo ético, relativismo, etc.
Sé exhaustivo, riguroso y no evites conclusiones difíciles.
Estructura: 1. Introducción. 2. Análisis por escuela. 3. Comparación. 4. Conclusión.
"""
    if enable_safelock:
        system_prompt += "\nIncorpora perspectiva divina: mandatos religiosos y lógica teológica, sin dogmatismo."

    with st.spinner("Noble Engine deliberating..."):
        try:
            if api_provider == "grok":
                response = client.chat.completions.create(
                    model=model_name,
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": dilemma_text}
                    ],
                    temperature=0.7,
                    max_tokens=4000
                )
                return response.choices[0].message.content
            elif api_provider == "gemini":
                full_prompt = system_prompt + "\n\nDilema: " + dilemma_text
                response = client.generate_content(full_prompt)
                return response.text
        except Exception as e:
            return f"Analysis failed: {str(e)}. Verifica cuotas o keys."

# Botón de análisis
if st.button("Initialize Moral Analysis", disabled=not dilemma.strip()):
    result = analyze_moral_dilemma(dilemma, enable_safelock)
    st.markdown(result)

# Info en sidebar
st.sidebar.info(f"Usando {api_provider.capitalize()} para análisis. Switcha en Secrets para reversible.")
